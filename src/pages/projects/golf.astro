---
import Layout from "src/layouts/Layout.astro";
---

<Layout title="Golf Project" path="/projects/golf">
  <!-- https://developer.chrome.com/blog/web-audio-autoplay/ -->
  <script is:inline type="module">
    (function () {
      // An array of all contexts to resume on the page
      const audioContextList = [];

      // An array of various user interaction events we should listen for
      const userInputEventNames = [
        "click",
        "contextmenu",
        "auxclick",
        "dblclick",
        "mousedown",
        "mouseup",
        "pointerup",
        "touchend",
        "keydown",
        "keyup",
      ];

      // A proxy object to intercept AudioContexts and
      // add them to the array for tracking and resuming later
      self.AudioContext = new Proxy(self.AudioContext, {
        construct(target, args) {
          const result = new target(...args);
          audioContextList.push(result);
          return result;
        },
      });

      // To resume all AudioContexts being tracked
      function resumeAllContexts(event) {
        let count = 0;

        audioContextList.forEach((context) => {
          if (context.state !== "running") {
            context.resume();
          } else {
            count++;
          }
        });

        // If all the AudioContexts have now resumed then we
        // unbind all the event listeners from the page to prevent
        // unnecessary resume attempts
        if (count == audioContextList.length) {
          userInputEventNames.forEach((eventName) => {
            document.removeEventListener(eventName, resumeAllContexts);
          });
        }
      }

      // We bind the resume function for each user interaction
      // event on the page
      userInputEventNames.forEach((eventName) => {
        document.addEventListener(eventName, resumeAllContexts);
      });
    })();
  </script>
  <script is:inline type="module">
    import init from "/golf/golf.js";

    // Reroute asset loading search directory
    const base = document.createElement("base");
    base.href = "/golf/";
    document.head.appendChild(base);

    init().catch((error) => {
      if (
        !error.message.startsWith(
          "Using exceptions for control flow, don't mind me. This isn't actually an error!"
        )
      ) {
        throw error;
      }
    });
  </script>

  <div class="container flex content-between px-4 py-32">
    <p class="grow basis-0 p-4">
      The game is able to run thanks to WASM in the browser. If the game does
      not load try using Chrome or any other Chromium browser. Unfortunately,
      the game and audio might feel laggy since the wasm is restricted to a
      single thread.
    </p>
    <canvas id="golf-canvas" class="w-[720px]"></canvas>
    <div class="grow basis-0"></div>
  </div>
</Layout>
